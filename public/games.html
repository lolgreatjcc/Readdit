<!--
Class: DIT/FT/1B/03
Name: Tan Yong Rui
Admission Number: P2004147
-->

<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Home</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="./css/home.css">
    <link rel="stylesheet" href="./css/general.css">
    <script>
        var pagenum = 1;
        var gameLength = -1;
        tmpToken = localStorage.getItem('token');
        function createCard(cardInfo) {
            var card = `
            <div class="card games col-5" style="margin-top: 2rem;">
                <div style="margin:auto;padding:10px">
                    <img src=`+ cardInfo.image + ` alt="cytus" style="width:380px;height:520px; object-fit: cover;">
                </div>
                <div class="card-body">
                    <p class="card-text">Title: ${cardInfo.title}</p>
                </div>
                    <div class="card-footer text-muted">
                    Price: $${cardInfo.price}
                    </div>

                `
            card += `<div class="card-footer text-muted">
                    <a href=viewGames.html?gameid=${cardInfo.gameid} class="btn btn-primary" class="View">View</a>
                </div>
            </div>`
            /*
             href="viewUsers.html
             href="/viewUsers.html

             href          |   Current Location                    | Target Location
             ---------------------------------------------------------------------
             a.html        |  http://abc.com/page1.html            | http://abc.com/a.html
             /a.html       |  http://abc.com/page1.html            | http://abc.com/a.html
             a.html        |  http://abc.com/sub/page1.html        | http://abc.com/sub/a.html
             /a.html       |  http://abc.com/sub/page1.html        | http://abc.com/a.html

             login.html    |  http://abc.com/catalog/products.html | http://abc.com/catalog/login.html
             /login.html   |  http://abc.com/catalog/products.html | http://abc.com/login.html

             http://abc.com/games.html?id=132
             http://abc.com/game?id=132
            */
            return card;
        }
        function getNumOfGames() {
            var userData;
            $.ajax({
                headers: { 'authorization': 'Bearer ' + tmpToken },
                async: false,
                url: `https://testapibackend.herokuapp.com/game/length/all`,
                type: 'GET',
                //data: data2,
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (data, textStatus, xhr) {
                    // if (data != null && data.success) {
                    //     //$('#msg').html('Record updated successfully!');
                    // } else {
                    //     console.log("Error");
                    gameLength = data.length;
                    console.log("Length: " + gameLength)
                    //     console.log(textStatus)
                    //     console.log(xhr)

                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log('Error in Operation');
                    console.log(xhr);
                    console.log(textStatus);
                    console.log(errorThrown);

                    if (xhr.status == 403) {
                        $('#msg').html('F̵̤̈ò̵̬r̶͙̃b̴͖͛i̶̲͒d̸̞̓d̵̮́e̷̬̐n̵̻̄');
                    }
                }
            });
            return userData;
        }
        function makePageNav() {
            if (gameLength == -1) {
                getNumOfGames()
            }
            var pageNav = "";
            if (pagenum > 1) {
                pageNav += `<button type = "button" class="btn btn-primary customBtn" id="previous1">Back</button>`
            }
            if (pagenum * 6 < gameLength) {
                pageNav += `<button type = "button" class="btn btn-primary customBtn" id="next1">Next</button>`
            }
            return pageNav;
        }
        function makePageNav2() {
            console.log("info")
            console.log("pagenum: " + pagenum)
            console.log("gameLength: " + gameLength)
            var pageNav = "";
            if (pagenum > 1) {
                pageNav += `<button type = "button" class="btn btn-primary customBtn" id="previous2">Back</button>`
            }
            if (pagenum * 6 < gameLength) {
                pageNav += `<button type = "button" class="btn btn-primary customBtn" id="next2">Next</button>`
            }
            return pageNav;
        }
        function getUserInfo() {
            var userData;
            $.ajax({
                headers: { 'authorization': 'Bearer ' + tmpToken },
                async: false,
                url: `https://testapibackend.herokuapp.com/payload`,
                type: 'GET',
                //data: data2,
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (data, textStatus, xhr) {
                    // if (data != null && data.success) {
                    //     //$('#msg').html('Record updated successfully!');
                    // } else {
                    //     console.log("Error");
                    userData = data;
                    //     console.log(textStatus)
                    //     console.log(xhr)

                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log('Error in Operation');
                    console.log(xhr);
                    console.log(textStatus);
                    console.log(errorThrown);

                    if (xhr.status == 403) {
                        $('#msg').html('F̵̤̈ò̵̬r̶͙̃b̴͖͛i̶̲͒d̸̞̓d̵̮́e̷̬̐n̵̻̄');
                    }
                }
            });
            return userData;
        }
        function loggedIn() {
            var stuff = ``;
            if (localStorage.getItem('token') != null) {
                if (getUserInfo().type == "Admin") {
                    stuff += `
                    <li class="nav-item">
                        <a class="nav-link" href="./addCat.html">Add Category</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./addGame.html">Add Game</a>
                    </li>`
                }
                stuff += `
                <li class="nav-item">
                        <a class="nav-link" href="./profile.html">Profile</a>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link Logout">Logout</button>
                </li>`
                $('.navbar-nav').append(stuff);
            }
            else {
                stuff = `<li class="nav-item">
                <a class="nav-link" href="./login.html">Login</a>
            </li>`
                $('.navbar-nav').append(stuff);
            }
        }
        function loadallgames() {

            // call the web service endpoint
            $.ajax({
                //headers: { 'authorization': 'Bearer ' + tmpToken },
                url: `https://testapibackend.herokuapp.com/games/${pagenum}/all/`,
                type: 'GET',
                //data: data2,
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (data, textStatus, xhr) {
                    $('#games').html("");
                    // if (data != null && data.success) {
                    //     //$('#msg').html('Record updated successfully!');
                    // } else {
                    //     console.log("Error");
                    console.log("data: " + data)
                    for (i = 0; i < data.length; i++) {
                        var game = data[i];
                        // compile the data that the card needs for it's creation
                        var cardInfo = {
                            "gameid": game.gameid,
                            "title": game.title,
                            "price": game.price,
                            "image": game.imagePath
                        }
                        $('#games').append(createCard(cardInfo));
                        console.log("------------Card Info Data Pack------------");
                        console.log(cardInfo);
                    }
                    console.log(gameLength)
                    $('#page').html(makePageNav());
                    //     console.log(textStatus)
                    //     console.log(xhr)

                    // }
                    // },
                    // error: function (xhr, textStatus, errorThrown) {
                    //     console.log('Error in Operation');
                    //     console.log(xhr);
                    //     console.log(textStatus);
                    //     console.log(errorThrown);

                    // if (xhr.status == 403) {
                    //     $('#msg').html('F̵̤̈ò̵̬r̶͙̃b̴͖͛i̶̲͒d̸̞̓d̵̮́e̷̬̐n̵̻̄');
                    // }
                }
            });

        };
        function loadSearchedGames() {
            console.log("loadSearchedGames")
            var platform = $('#platform').val();
            var title = $('#title').val();
            if (title == "") {
                console.log(true);
                title = '{*,.}';
            }
            var price = $('#price').val();
            if (price == "") {
                console.log(true);
                price = '{*,.}';
            }
            // call the web service endpoint (get length)
            $.ajax({
                //headers: { 'authorization': 'Bearer ' + tmpToken },
                url: `https://testapibackend.herokuapp.com/games/${platform}/${title}/${price}/${pagenum}/length`,
                type: 'GET',
                async: false,
                //data: data,
                contentType: "application/json; charset=utf-8",
                //dataType: 'json',
                success: function (data, textStatus, xhr) {
                    //$('#games').html("");
                    // if (data != null && data.success) {
                    //     //$('#msg').html('Record updated successfully!');
                    // } else {
                    //     console.log("Error");
                    console.log(data);
                    gameLength = data.Length;
                }
            });

            $.ajax({
                //headers: { 'authorization': 'Bearer ' + tmpToken },
                url: `https://testapibackend.herokuapp.com/games/${platform}/${title}/${price}/${pagenum}`,
                type: 'GET',
                //data: data,
                contentType: "application/json; charset=utf-8",
                //dataType: 'json',
                success: function (data, textStatus, xhr) {
                    $('#games').html("");
                    // if (data != null && data.success) {
                    //     //$('#msg').html('Record updated successfully!');
                    // } else {
                    //     console.log("Error");
                    console.log(data)
                    console.log(data.length);
                    for (i = 0; i < data.length; i++) {

                        var game = data[i];
                        // compile the data that the card needs for it's creation
                        var cardInfo = {
                            "gameid": game.gameid,
                            "title": game.title,
                            "price": game.price,
                            "image": game.imagePath

                        }
                        if (data.length == 1) {
                            console.log("This is going to run")
                            $('#games').html(createCard(cardInfo));
                        }
                        else {
                            $('#games').append(createCard(cardInfo));
                        }
                        console.log("------------Card Info Data Pack------------");
                        console.log(createCard(cardInfo));
                    }

                    $('#page').html(makePageNav2());

                    if(data.length==0){
                        $('#games').html(`<Text>No games matching searched queries</Text>`)
                    }
                }
            });

        };

        $(document).ready(function () {
            loadallgames();
            loggedIn();
            $(".Logout").click(function () {
                window.localStorage.clear();
                window.location.assign("https://tyrgames.herokuapp.com/login.html");
            });
            $("#Search").click(function () {
                pagenum = 1;
                $('#games').html("");
                console.log("Searched button clicked.")
                loadSearchedGames();
            });
        })
        $(document).on('click', '#next1', function () {
            console.log("Next button clicked");
            pagenum += 1;
            loadallgames()
        })
        $(document).on('click', '#previous1', function () {
            console.log("back button clicked");
            pagenum -= 1;
            loadallgames()
        })
        $(document).on('click', '#next2', function () {
            console.log("Next button clicked");
            pagenum += 1;
            loadSearchedGames()
        })
        $(document).on('click', '#previous2', function () {
            console.log("back button clicked");
            pagenum -= 1;
            loadSearchedGames()
        })

    </script>

</head>

<body>
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark sticky-top">
        <!-- Brand/logo -->
        <a class="navbar-brand" href="#">SP Games+</a>
        <!-- Links -->
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="./home.html">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Games</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="./about.html">About Us</a>
            </li>
        </ul>
    </nav>
    <div class="container">
    </div>
    <h1 class="bg-info header">Games</h1>
    <div class="container">
        <div style="margin-top: 2rem;">
            <div class="jumbotron">
                <div>Search for a game:</div>
                <form id="search-user-form" style="margin-top: 2rem;">
                    <label for="title">Title:</label>
                    <input type="text" id="title" name="title">
                    <label for="platform">Platform:</label>
                    <select name="platform" id="platform">
                        <option value="All">All</option>
                        <option value="PC">PC</option>
                        <option value="Mobile">Mobile</option>
                        <option value="PS">PS</option>
                        <option value="XBOX">XBOX</option>
                    </select>
                    <label for="price">Price:</label>
                    <input type="number" id="price" name="price">
                    <button type="button" class="btn btn-primary" id="Search">Search Games</button>
                </form>
                <div class="msg"></div>
    
                <div id="games" class="row">
                </div>
    
                <div id="page">
                </div>
            </div>
        </div>
    </div>

<!-- Background image reference -->
<section class="p-2 bg-secondary text-light">
    Background pattern obtained from <a href="https://www.toptal.com/designers/subtlepatterns/congruent-pentagon/"
        target="_blank">here</a>.
</section>

<!-- Footer -->
<footer class="darkbrown p-2 text-center text-light"><em>SP Games+</em> &#9702; Dover Link 74 &#9702; Singapore 735462</footer>

</body>

</html>