<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="../includeHTMLs/head.js"></script>
    <script src="../includeHTMLs/header.js"></script>
    <!-- <script src="../js/subreaddit.js"></script> -->

    <title>Community</title>
</head>

<body>
    <div class="container-xxl">
        <div class="row">


            <div class="col-1">
                start
            </div>
            <div class="col-11">
                end
            </div>
        </div>
    </div>
    <div class="container-xxl my-md-4">
        <div class="row">
            <div class="col-lg-8" id="post_div">
                <div class=" bg-white body-borders px-3 py-2 mb-3 rounded shadow-sm">
                    <form>
                        <div class="d-flex">
                            <div class="input-group">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">r/all</button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#">Action</a></li>
                                </ul>
                                <input class="form-control col-8" placeholder="Create Post">

                            </div>
                            <a href="#" class="px-3 py-1 mx-2 icon-hover rounded-3"><i
                                    class="far fa-file-image align-middle text-dark"></i></a>
                            <a href="#" class="px-3 py-1 mx-2 icon-hover rounded-3"><i
                                    class="fas fa-paperclip align-middle text-dark lh-inherit"></i></i></a>
                        </div>
                    </form>
                </div>


                <div class="post rounded mb-2">
                    <div class="row g-0">
                        <div class="col-1 upvote-section py-2 justify-content-center">
                            <a class="text-center d-block py-1" id="post1-upvote"><i
                                    class="fas fa-arrow-up text-dark"></i></a>
                            <p id="post#-val" class="text-center mb-0">6920</p>
                            <a class="text-center d-block py-1" id="post1-downvote"><i
                                    class="fas fa-arrow-down text-dark"></i></a>
                        </div>
                        <div class="col-11 bg-white p-2">
                            <div class="d-flex flex-row align-items-baseline">
                                <h6 class="d-inline fw-bold clickable-link">r/news</h6>
                                <p class="fw-light text-secondary mx-1">•</p>
                                <p class="d-inline text-secondary me-1">Posted by</p>
                                <p class="d-inline text-secondary clickable-link" id="post#_user"> u/Ben</p>
                                <p class="fw-light text-secondary mx-1">•</p>
                                <p class="text-secondary" id="post#_time">4 hours ago</p>
                            </div>
                            <h5>A really cool post. Lorem Ipsum Dolor sit amet consectetur</h5>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="bg-white body-borders rounded shadow-sm mb-3">
                    <div class="invert-scheme p-2 py-3 rounded-top" id="about_community_header">
                        <div class="ms-2">
                            <h6 class="fw-bolder text-white mb-0" id="community_name"></h6>
                            <small class="fw-normal">r/<span id="subreaddit_name"></span></small>
                        </div>

                    </div>
                    <div class="p-2">
                        <a class="btn btn-dark body-borders rounded-pill invert-scheme fw-bold w-100">Join Community</a>
                    </div>
                </div>
                <div class="bg-white body-borders rounded shadow-sm mb-3" id="moderator">

                </div>
                <div class="bg-white body-borders rounded shadow-sm">
                    <div id="about_community_header" class="p-2 py-3 rounded-top">
                        <h6 class="fw-bold text-white mb-0 ms-2">About Community</h6>
                    </div>
                    <div class="p-2">
                        <p id="community_desc">Short description about subreaddit</p>
                        <p class="text-center mb-0">##</p>
                        <p class="text-center">Members</p>
                        <hr />
                        <div class="d-flex flex-row align-items-center mx-3">
                            <i class="fas fa-birthday-cake fa-xl text-scheme"></i>
                            <p class="ms-2 mb-0 fw-bold text-scheme">Created</p>
                            <p class="ms-1 mb-0" id="community_create_month">MMM</p>
                            <p class="ms-1 mb-0" id="community_create_day">DD</p>
                            <p class="mb-0">,</p>
                            <p class="ms-1 mb-0" id="community_create_year">YYYY</p>
                        </div>
                        <hr class="mb-2" />
                        <a class="btn btn-dark body-borders rounded-pill invert-scheme fw-bold w-100">Create Post</a>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script>
        $(document).ready(function () {
            var pathname = window.location.pathname;
            $.ajax({
                url: `http://localhost:3000` + pathname,
                method: 'GET',
                contentType: "application/json; charset=utf-8",
                success: function (data, status, xhr) {

                    data = JSON.parse(data);
                    $("#community_name").html(data.subreaddit_name);
                    $("#subreaddit_name").html(data.subreaddit_name);
                    checkOwner(data.subreaddit_name);
                    $('#community_desc').html(data.subreaddit_description)
                    var date = new Date(data.created_at);
                    var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
                    $('#community_create_month').html(months[date.getMonth() - 1]);
                    $('#community_create_day').html(date.getDate());
                    $('#community_create_year').html(date.getFullYear());
                },
                error: function (xhr, status, error) {

                }
            })

            $.ajax({
                url: `http://localhost:3000/post/get` + pathname,
                method: 'GET',
                contentType: "application/json; charset=utf-8",
                success: function (data, status, xhr) {
                    console.log(data);
                    for (var i = 0; i < data.length; i++) {

                        // Calculates Time
                        var date = new Date(data[i].created_at);
                        var date_now = new Date();
                        var seconds_between_dates = Math.floor((date_now - date) / 1000);
                        var minutes_between_dates = Math.floor((date_now - date) / (60 * 1000));
                        var hours_between_dates = Math.floor((date_now - date) / (60 * 60 * 1000));
                        var days_between_dates = Math.floor((date_now - date) / (60 * 60 * 24 * 1000))
                        var weeks_between_dates = Math.floor((date_now - date) / (60 * 60 * 24 * 7 * 1000))

                        var post_date_output;
                        console.log(minutes_between_dates)
                        if (seconds_between_dates < 60) {
                            post_date_output = `${seconds_between_dates} seconds ago`
                        } else if (minutes_between_dates < 60) {
                            post_date_output = `${minutes_between_dates} minutes ago`
                        }
                        else if (hours_between_dates < 24) {
                            post_date_output = `${hours_between_dates} hours ago`
                        } else if (days_between_dates <= 7) {
                            post_date_output = `${days_between_dates} days ago`
                        } else {
                            post_date_output = `${weeks_between_dates} weeks ago`
                        }


                        $('#post_div').append(`
                        
                        <div class="post rounded mb-2" id="post_${data[i].post_id}">
                        <div class="row g-0">
                        <div class="col-1 upvote-section py-2 justify-content-center">
                            <a class="text-center d-block py-1 post-upvote" id="post_${data[i].post_id}_upvote"><i
                                    class="fas fa-arrow-up text-dark"></i></a>
                            <p id="post#-val" class="text-center mb-0">####</p>
                            <a class="text-center d-block py-1 post-downvote" id="post_${data[i].post_id}_downvote"><i
                                    class="fas fa-arrow-down text-dark"></i></a>
                        </div>
                        <div class="col-11 bg-white p-2">
                            
                            <div class="d-flex flex-row align-items-baseline">
                                <h6 class="d-inline fw-bold clickable-link">r/<a>${data[i].Subreaddit.subreaddit_name}</a></h6>
                                <p class="fw-light text-secondary mx-1">•</p>
                                <p class="d-inline text-secondary me-1">Posted by</p>
                                <p class="d-inline text-secondary clickable-link" id="post_${data[i].User.username}_user"> u/<a>${data[i].User.username}</a></p>
                                <p class="fw-light text-secondary mx-1">•</p>
                                <p class="text-secondary" id="post_${data[i].post_id}_time">${post_date_output}</p>
                            </div>

                            <h5 id="post_${data[i].post_id}_content">${data[i].content}</h5>
                            <div class="toolbar d-flex flex-row align-items-center mt-2">
                                    <div class="d-flex flex-row text-secondary me-4 p-1 rounded hoverable">
                                        <span class="material-icons md-24 ms-0 me-1">chat_bubble_outline</span>
                                        <p class="mb-0 fw-bold me-1" id="comment_total"></p>
                                        <p class="mb-0 fw-bold fs-6">Comments</p>
                                    </div>
                                    <div class="d-flex flex-row text-secondary me-4 p-1 rounded hoverable">
                                        <span class="material-icons md-24 ms-0 mx-1">share</span>
                                        <p class="mb-0 fw-bold fs-6">Share</p>
                                    </div>
                                    <div class="save d-flex flex-row text-secondary me-4 p-1 rounded hoverable" id="post_bookmark_${data[i].post_id}">
                                        <span class="material-icons ms-0">bookmark</span>
                                        <p class="mb-0 fw-bold fs-6">Unsave</p>
                                    </div>
                                    <div class="d-flex flex-row text-secondary me-4 p-1 rounded hoverable">
                                        <span class="material-icons md-24 mx-1 ms-0">outlined_flag</span>
                                        <p class="mb-0 fw-bold fs-6">Report</p>
                                    </div>
                            </div>

                        </div>
                        
                        </div>
                        </div>
                        
                    `)
                    }

                    

                    // Handle Saving of Posts
                    $('.save').on('click', function (e) {
                        e.stopPropagation();
                        var save_button = $(this);
                        var post_id = $(this).attr('id').split('_')[2];

                        // temp user_id
                        var user_id = 2;

                        if (save_button.hasClass('saved')) {
                            save_button.removeClass('saved');
                            save_button.empty();
                            save_button.append(`
                                <span class="material-icons md-24 ms-0">bookmark_border</span>
                                <p class="mb-0 fw-bold fs-6">Save</p>
                            `);



                            $.ajax({
                                url: "http://localhost:3000/save/post",
                                type: "DELETE",
                                data: JSON.stringify({
                                    user_id: user_id,
                                    post_id: post_id
                                }),
                                contentType: "application/json",
                                success: function (data, status, xhr) {
                                    console.log(data);
                                    // do modal
                                },
                                error: function (xhr, status, error) {
                                    console.log(xhr)
                                }
                            })

                        } else {
                            save_button.addClass('saved');
                            save_button.empty();
                            save_button.append(`
                                <span class="material-icons md-24 ms-0">bookmark</span>
                                <p class="mb-0 fw-bold fs-6">Unsave</p>
                            `);
                            $.ajax({

                                url: `http://localhost:3000/save/post`,
                                method: 'POST',
                                data: JSON.stringify({
                                    post_id: post_id,
                                    user_id: user_id
                                }),
                                contentType: "application/json; charset=utf-8",
                                success: function (data, status, xhr) {
                                    console.log(data)
                                    // do modal
                                },
                                error: function (xhr, status, error) {
                                    console.log(xhr);
                                }
                            })
                        }
                    })

                    // Handles clicking on a post
                    $('.post').on('click', function (e) {
                        var post =  $(this);
                        var post_id = post.attr('id').split('_')[1];
                        var subreaddit = pathname;
                        location.href = `${subreaddit}/${post_id}`;
                    })

                },
                error: function (xhr, status, error) {
                    console.log(xhr);
                }
            })
        })

        function checkOwner(subreadditName) {
            var token = localStorage.getItem("token");
            $.ajax({
                url: `http://localhost:3000/r/checkOwner/` + subreadditName,
                method: 'GET',
                contentType: "application/json; charset=utf-8",
                headers: { authorization: "Bearer " + token },
                success: function (data, status, xhr) {
                    $("#moderator").html(`
                    <div id="about_community_header" class="p-2 py-3 rounded-top">
                        <h6 class="fw-bold text-white mb-0 ms-2">Moderators</h6>
                    </div>
                    <div class="p-2" >
                        <a class="btn btn-dark body-borders rounded-pill invert-scheme fw-bold w-100" href="/moderator?subreaddit=${subreadditName}">Edit Moderators</a>
                    </div>
                    `)
                },
                error: function (xhr, status, error) {
                    console.log("")
                }
            });
        }
    </script>
</body>

</html>