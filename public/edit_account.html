<!--Tan Yong Rui DIT/FT/2B/03 P2004147-->
<!DOCTYPE html>

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Readdit</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="css/edit_form.css">

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script src="./includeHTMLs/head.js"></script>
    <script src="./includeHTMLs/header.js"></script>
    <script>

        function loadUserInfo() {
            var { user_id } = JSON.parse(localStorage.getItem("userInfo"))
            var token = localStorage.getItem("token")
            // call the web service endpoint
            $.ajax({
                url: `http://localhost:3000/users/` + user_id,
                // url: 'https://readdit-backend.herokuapp.com/users/'+ user_id,
                type: 'GET',
                //data: data2,
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                headers: {
                    "authorization": `Bearer ${token}`
                },
                success: function (data, textStatus, xhr) {
                    $('#users').html("");
                    // if (data != null && data.success) {
                    //     //$('#msg').html('Record updated successfully!');
                    // } else {
                    //     console.log("Error");
                    data = data.Result;
                    console.log("data: " + data.profile_pic)
                    var user = data;
                    // compile the data that the card needs for it's creation

                    document.getElementById("username").value = user.username;
                    document.getElementById("email").value = user.email;
                    document.getElementById("pfpImg").value = user.profile_pic;
                    if (data.two_fa === "undefined" || data.two_fa == null || data.two_fa == 0) {
                        document.getElementById("two_fa").checked = false;
                    }
                    else {
                        document.getElementById("two_fa").checked = true;
                    }

                    try {
                        if (user.profile_pic === "undefined" || user.profile_pic == null || user.profile_pic.trim().length == 0 || user.profile_pic == "NULL") {
                            $('#pfpImg').html('<img src="https://res.cloudinary.com/readditmedia/image/upload/v1635600054/media/reddit_jjs25s.png" alt="profile image" id="pfp" class="pb-2"></img><br>')
                        }
                        else {
                            console.log("Pfp: " + user.profile_pic);
                            var pfpTempString = user.profile_pic.split("upload");
                            user.profile_pic = pfpTempString[0] + "upload" + "/ar_1.0,c_fill/r_max" + pfpTempString[1]
                            $('#pfpImg').html('<img src="' + user.profile_pic + '" alt="profile image" id="pfp" class="pb-2"></img><br>')
                        }
                    }
                    catch (error) {
                        $('#pfpImg').html('<img src="https://res.cloudinary.com/readditmedia/image/upload/v1635600054/media/reddit_jjs25s.png" alt="profile image" id="pfp" class="pb-2"></img><br>')
                        console.log(error)
                    }

                    $('#loadingText').html("");
                    //     console.log(textStatus)
                    //     console.log(xhr)

                    // }
                },


                error: function (xhr, textStatus, errorThrown) {
                    console.log('Error in Operation');
                    console.log(xhr);
                    console.log(textStatus);
                    console.log(errorThrown);
                    $('#loadingText').html("<h6 class='text-danger'>ERROR LOADING!</h6>");
                    if (xhr.status == 403) {
                        $('#msg').html('F̵̤̈ò̵̬r̶͙̃b̴͖͛i̶̲͒d̸̞̓d̵̮́e̷̬̐n̵̻̄');
                    }
                }
            });
        };

        function editUser() {
            $(`#messages`).html("<p class='text-center text-primary pt-2'>Submitting...</p>");
            var email = $('#email').val();
            var oldpwd = $('#oldpwd').val();
            var newpwd = $('#newpwd').val();
            var username = $('#username').val();
            var pfpImg = $('#pfpImg').val();
            var two_fa = $('#two_fa').is(":checked");

            try {
                if (two_fa == true) {
                    two_fa = 1;
                }
                else {
                    two_fa = 0;
                }
            }
            catch (error) {
                console.log("Error in two_fa conversion. Error: " + error)
            }

            var { user_id } = JSON.parse(localStorage.getItem("userInfo"));
            var token = localStorage.getItem("token");
            let webFormData = new FormData();
            webFormData.append('email', email);
            webFormData.append('oldpwd', oldpwd);
            webFormData.append('newpwd', newpwd);
            webFormData.append('username', username);
            webFormData.append('profile_pic', pfpImg);
            webFormData.append('two_fa', two_fa);
            // HTML file input, chosen by user
            webFormData.append("image", document.getElementById('image').files[0]);
            console.log(...webFormData);
            //  call web service endpoint
            $.ajax({
                // url: 'https://readdit-backend.herokuapp.com/users/' + user_id,
                url: `http://localhost:3000/users/` + user_id,
                method: 'PUT',
                data: webFormData,
                processData: false,
                contentType: false,
                cache: false,
                enctype: 'multipart/form-data',
                headers: { authorization: 'Bearer ' + token },
                success: function (data, textStatus, xhr) {
                    console.log("Running ajax")
                    if (data != null) {
                        console.log(data)
                        $(`#messages`).html("<p class='text-center text-success pt-2'>Changes Saved.</p>");
                    } else {
                        console.log("Error");
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log("Xhr: " + xhr);
                    console.log("textStatus: " + textStatus);
                    console.log("errorThrown: " + errorThrown);
                    console.log('Error in Operation');

                    $(`#messages`).html("<p class='text-center text-danger pt-2'>Failed To Save Changes</p>");
                }
            });
            return false;
        }

        $(document).ready(function () {
            loadUserInfo();
            document.getElementById('two_fa').addEventListener('change', (e) => {
                this.checkboxValue = e.target.checked ? 'on' : 'off';
                console.log(this.checkboxValue)
            })
        })

    </script>
</head>

<body>
    <div id="edit_form_container" class="login-form">
        <h1 class="text-center">Edit Account</h1>
        <form id="edit_form" enctype="multipart/form-data" onsubmit="editUser()" action="javascript:void(0)">
            <div class="form-group text-center" id="pfpImg">
            </div>

            <div class="form-group">
                <label for="username">Username:</label><br>
                <input type="text" id="username" class="form-control" name="username" placeholder="Username"
                    required="required" /><br>
            </div>
            <div class="form-group">
                <label for="email">Email:</label><br>
                <input type="text" id="email" class="form-control" name="email" placeholder="Email"
                    required="required" /><br>
            </div>
            <div class="form-group">
                <label for="image">Select New Image for Profile Picture (Optional):</label><br>
                <input type="file" id="image" name="image" /><br><br>
            </div>
            <div class="form-group">
                <input type="text" id="pfpImg" name="pfpImg" hidden />
            </div>
            <div class="form-group pb-4">
                <p class="d-inline">2 Factor Authentication</p>
                <label class="switch float-right">
                    <input type="checkbox" id="two_fa">
                    <span class="slider round "></span>
                </label>
            </div>
            <div class="form-group">
                <label for="newpwd">New Password (Optional):</label><br>
                <input type="password" id="newpwd" class="form-control" name="newpwd"
                    placeholder="New Password (Optional)" /><br>
            </div>
            <div class="form-group">
                <label for="oldpwd">Enter Old Password To Save Changes:</label><br>
                <input type="password" id="oldpwd" class="form-control" name="oldpwd" placeholder="Old Password"
                    required="required" /><br>
            </div>

            <button type="submit" class="btn btn-primary btn-block" id="Submit">Submit</button>
            <div id="messages">
            </div>
        </form>

    </div>
</body>

</html>