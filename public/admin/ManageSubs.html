<!-- ADES CA1 Play2Win -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Readdit</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script src="../includeHTMLs/head.js"></script>
    <script src="../includeHTMLs/header.js"></script>

    <script>

        function displaySubs() {
            // call the web service endpoint
            $.ajax({
                //headers: { 'authorization': 'Bearer ' + tmpToken },
                url: 'http://localhost:3000/r/subreaddits',
                type: 'GET',
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (data, textStatus, xhr) {
                    var appendString = "";
                    for (var i = 0; i < data.Result.length; i++) {
                        var subreaddits = data.Result[i];
                        appendString += `<tr>
                                                <th scope="row">${i + 1}</th>
                                                <td>${subreaddits.subreaddit_name}</td>
                                                <td>${subreaddits.subreaddit_description}</td>
                                                <td>${subreaddits["User.creator"]}</td>
                                                <td>${subreaddits.created_at}</td>
                                                <td> <button type="submit" name="${subreaddits.subreaddit_name}" id = "${subreaddits.subreaddit_id}" class="EditCall" style="background-color:#6a5acd; color:white; border-width: 0px;">Edit</button> </td>
                                                <td> <button type="submit" id = "${subreaddits.subreaddit_id}" name="${subreaddits.subreaddit_name}" class="DeleteCall" style="background-color:#6a5acd; color:white; border-width: 0px;">Delete</button> </td>
                                            </tr>`;
                    }
                    $("#load").html("");
                    $("#subreaddits").append(appendString);

                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log('Error in Operation');
                    console.log(xhr)
                    console.log(textStatus);
                    console.log(errorThrown);
                    console.log(xhr.status);
                    //if (xhr.status == 401) {
                    //    $('$msg').html('Unauthorised User');
                    //}
                }
            });

        }

        $(document).ready(function () {
            try {
                var userData = localStorage.getItem('userInfo');
                var token = localStorage.getItem("token")
                // userData = userData.slice(1,-1);

                var userJsonData = JSON.parse(userData);
                var role = userJsonData.fk_user_type_id;

                var tmpToken = localStorage.getItem('token');

                if (role != 2) {
                    alert("Unauthorized User!");
                    window.location.assign("http://localhost:3001/home.html");
                }
            } catch (error) {
                alert("Unauthenticated User!");
                window.location.assign("http://localhost:3001/login.html");
            }

            displaySubs();

            $("#return").click(function () {
                window.location.assign("http://localhost:3001/admin/admin_home.html");
            });

            $('body').on('click', '.DeleteCall', function () {
                var subreaddit_id = event.srcElement.id;
                var subreaddit_name = event.srcElement.name;
                console.log(subreaddit_id);
                var check = confirm("Delete " + subreaddit_name + "?");
                if (check) {
                    $.ajax({
                        //headers: { 'authorization': 'Bearer ' + tmpToken },
                        url: 'http://localhost:3000/r/subreaddit/' + subreaddit_id,
                        type: 'DELETE',
                        contentType: "application/json; charset=utf-8",
                        dataType: 'json',
                        success: function (data, textStatus, xhr) {
                            location.reload();
                        },
                        error: function (xhr, textStatus, errorThrown) {
                            console.log('Error in Operation');
                            console.log(xhr)
                            console.log(textStatus);
                            console.log(errorThrown);
                            console.log(xhr.status);
                            //if (xhr.status == 401) {
                            //    $('$msg').html('Unauthorised User');
                            //}
                        }
                    });
                }
            });

            $('body').on('click', '.EditCall', function () {
                var subreaddit_id = event.srcElement.id;
                window.location.assign("http://localhost:3001/admin/editSubs.html?id=" + subreaddit_id);
            });
        });

    </script>

</head>

<body>
    <div class="container">
    </div>
    <div class="container">
        <h2>Manage Subreaddits</h2>
        <div>

            <table class="table">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Name</th>
                        <th scope="col">Description</th>
                        <th scope="col">Owner</th>
                        <th scope="col">Created At</th>
                        <th scope="col"></th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody id="subreaddits">

                </tbody>
            </table>
            <div id="load">
                <h5>LOADING SUBREADDITS TABLE...</h5>
            </div>
        </div>
        <button type="submit" class="btn btn-block"
            style="background-color: #6a5acd; color : white; margin: 30px; width: 500px;" id="return">Return</button>
    </div>



</body>

</html>